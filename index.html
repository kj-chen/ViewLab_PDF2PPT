<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>觀點LAB - AI 圖片文字移除 金鑰版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js 核心 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- PptxGenJS -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- JSZip (打包下載必備) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .drop-zone-active { border-color: #2563eb !important; background-color: #eff6ff !important; transform: scale(1.01); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .pdf-view-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--page-width, 200px), 1fr)); gap: 1.5rem; }
        .pdf-view-scroll { display: flex; gap: 1.5rem; overflow-x: auto; padding-bottom: 1rem; white-space: nowrap; }
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .page-card { transition: all 0.2s ease; border: 2px solid transparent; }
        .page-card:hover { transform: translateY(-3px); border-color: #3b82f6; }
        
        /* 槽位與狀態樣式 */
        .slot-card { position: relative; overflow: hidden; }
        .status-badge { position: absolute; top: 0.5rem; left: 0.5rem; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; z-index: 10; pointer-events: none; }
        .badge-error { background: #ef4444; color: white; }
        .badge-processing { background: #3b82f6; color: white; }
        .badge-done { background: #10b981; color: white; }

        /* API Key Status Colors */
        .status-idle { color: #94a3b8; }
        .status-success { color: #10b981; }
        .status-error { color: #ef4444; }
        .status-loading { color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen text-slate-900 pb-20">

    <div class="max-w-7xl mx-auto px-4 py-10">
        <!-- 標題與 API 設定區 -->
        <header class="mb-10 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter italic">觀點LAB - AI 圖片文字移除 <span class="text-blue-600">PRO</span></h1>
                <p class="text-slate-500 font-bold mt-1 text-lg">高精度佈局還原 & 智慧內容填補系統</p>
            </div>

            <!-- API 金鑰輸入區 -->
            <div class="w-full lg:w-auto bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row items-center gap-4">
                <div class="flex-1 min-w-[300px]">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-1">Gemini API Key 設定</label>
                    <div class="relative">
                        <input type="password" id="api-key-input" placeholder="在此輸入您的 API Key..." 
                            class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <div id="key-check-loader" class="absolute right-3 top-2 hidden"><div class="loader !w-4 !h-4"></div></div>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="verify-key-btn" class="bg-slate-900 hover:bg-black text-white px-5 py-2.5 rounded-xl text-xs font-black shadow-lg transition whitespace-nowrap">驗證金鑰</button>
                    <div id="api-status-box" class="flex items-center gap-2 px-3 py-2 bg-slate-50 rounded-xl border border-slate-100">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                        <span id="status-text" class="text-[10px] font-black uppercase tracking-widest status-idle">尚未驗證</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- PDF 解析區 -->
        <section class="mb-12">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center font-black">1</div>
                    <h2 class="text-xl font-black text-slate-800">PDF 高精細解析</h2>
                </div>
                
                <div id="pdf-controls" class="hidden flex flex-wrap items-center gap-4 bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex items-center gap-2 bg-slate-50 px-2 py-1 rounded-xl border border-slate-100">
                        <span class="text-[10px] font-black text-slate-400 uppercase">佈局比例</span>
                        <select id="pdf-ratio-select" class="text-xs font-black border-none bg-transparent outline-none cursor-pointer text-blue-600">
                            <option value="16:9">16:9 (橫)</option>
                            <option value="9:16">9:16 (直)</option>
                            <option value="4:3">4:3 (標)</option>
                        </select>
                    </div>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <button id="view-grid-btn" class="px-3 py-1 text-xs font-black rounded-lg bg-white shadow-sm text-blue-600">網格檢視</button>
                        <button id="view-scroll-btn" class="px-3 py-1 text-xs font-black rounded-lg text-slate-500 hover:text-slate-700">橫向捲動</button>
                    </div>
                    <button id="add-all-pages-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg transition">一鍵導入工作台</button>
                </div>
            </div>

            <div id="pdf-drop-zone" class="bg-white rounded-3xl border-2 border-dashed border-slate-200 p-12 text-center cursor-pointer hover:border-blue-400 transition-all group shadow-sm">
                <input type="file" id="pdf-file-input" class="hidden" accept="application/pdf">
                <div id="pdf-empty-state">
                    <p class="text-xl font-black text-slate-800">點擊或拖放 PDF 進行解析</p>
                    <p class="text-slate-400 text-sm font-semibold mt-1 italic">系統將自動提取頁面並支援轉換為 PPTX</p>
                </div>
                <div id="pdf-preview-container" class="hidden text-left">
                    <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl mb-6 border border-slate-100">
                        <span id="page-count-tag" class="bg-slate-900 text-white px-3 py-1 rounded-full text-[10px] font-black tracking-widest uppercase">0 PAGES</span>
                        <div class="flex gap-2">
                            <button id="pdf-to-pptx-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-xl font-black text-xs shadow-lg flex items-center gap-2 disabled:opacity-50">
                                <span id="pptx-btn-text">視覺辨識文字 PPTX</span>
                                <div id="pptx-loader" class="loader !w-3 !h-3 !border-white !border-t-transparent hidden"></div>
                            </button>
                            <button id="clear-pdf-btn" class="text-xs font-black text-red-500 px-4 hover:underline">清除</button>
                        </div>
                    </div>
                    <div id="pdf-pages-list" class="pdf-view-grid custom-scrollbar"></div>
                </div>
            </div>
        </section>

        <!-- 圖片去字工作台 -->
        <section>
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center font-black">2</div>
                    <h2 class="text-xl font-black text-slate-800">圖片去文字工作台</h2>
                </div>
                <div class="flex items-center gap-4 flex-wrap justify-end">
                    <div id="result-export-group" class="hidden flex items-center gap-3 bg-white px-4 py-2 rounded-2xl shadow-sm border border-slate-100">
                        <button id="download-all-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg transition">打包下載背景圖 (ZIP)</button>
                        <button id="export-results-pptx-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg">導出背景圖 PPTX</button>
                    </div>

                    <div class="flex items-center gap-4 bg-white px-3 py-2 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex items-center gap-2">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-tighter">槽位數量</label>
                            <select id="slot-count-select" class="text-xs font-black border-none bg-transparent outline-none cursor-pointer text-blue-600">
                                <option value="4">04</option>
                                <option value="8">08</option>
                                <option value="12">12</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>

                    <button id="process-all-btn" class="bg-slate-900 hover:bg-black text-white px-6 py-2 rounded-xl text-xs font-black shadow-lg hidden transition disabled:opacity-50">開始批次處理</button>
                    <button id="clear-all-slots-btn" class="hidden text-xs font-black text-red-500 px-2 hover:underline">全部清除</button>
                </div>
            </div>

            <div id="master-drop-zone" class="bg-white border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center cursor-pointer hover:border-blue-400 transition-all mb-8 shadow-sm group">
                <input type="file" id="master-file-input" class="hidden" accept="image/*" multiple>
                <div class="flex flex-col items-center gap-2">
                    <p class="text-slate-500 font-bold">在此上傳或從 PDF 區域導入圖片</p>
                </div>
            </div>

            <div id="slots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </section>
    </div>

    <!-- 槽位模板 -->
    <template id="slot-template">
        <div class="slot-card bg-white rounded-3xl border border-slate-100 p-5 flex flex-col shadow-sm">
            <div id="slot-status-badge" class="status-badge hidden"></div>
            <div class="empty-state flex-grow flex flex-col items-center justify-center text-slate-200 italic font-black text-sm min-h-[250px]">
                <div class="w-10 h-10 border-2 border-dashed border-slate-100 rounded-lg flex items-center justify-center mb-2">+</div>
                Empty
            </div>
            <div class="active-state hidden flex-grow flex flex-col">
                <div class="flex justify-between mb-4">
                    <span class="text-[10px] font-black text-blue-600 italic slot-label uppercase">SLOT 01</span>
                    <button class="remove-btn text-slate-300 hover:text-red-500 transition font-black">×</button>
                </div>
                <div class="space-y-4">
                    <div class="aspect-video bg-slate-50 rounded-xl overflow-hidden border border-slate-100 relative shadow-inner">
                        <img class="original-img w-full h-full object-contain" src="">
                        <div class="slot-loader absolute inset-0 bg-white/80 hidden flex flex-col items-center justify-center">
                            <div class="loader mb-2"></div>
                            <span class="text-[10px] font-black text-blue-600 uppercase">Processing...</span>
                        </div>
                    </div>
                    <div class="aspect-video bg-slate-50 rounded-xl overflow-hidden border border-slate-100 flex items-center justify-center shadow-inner relative">
                        <img class="result-img w-full h-full object-contain hidden" src="">
                        <div id="error-overlay" class="absolute inset-0 bg-red-50/90 hidden flex-col items-center justify-center p-2 text-center">
                            <span class="text-[10px] font-black text-red-500 uppercase mb-1">Error Occurred</span>
                            <span id="error-msg" class="text-[8px] font-bold text-red-400 line-clamp-2"></span>
                        </div>
                        <div class="placeholder text-slate-200 italic font-black text-[10px] uppercase">No Result</div>
                    </div>
                </div>
                <div class="flex gap-2 mt-5">
                    <button class="process-btn bg-slate-900 hover:bg-black text-white text-[10px] py-2.5 rounded-lg flex-1 font-black transition disabled:opacity-30">去文字</button>
                    <button class="download-btn bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] px-3 rounded-lg font-black disabled:opacity-20 transition" disabled>下載</button>
                </div>
            </div>
        </div>
    </template>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-2xl shadow-2xl opacity-0 transition-all pointer-events-none z-50 text-sm font-black border border-slate-700"></div>

    <script>
        // --- 全域狀態 ---
        let userApiKey = localStorage.getItem('gemini_api_key') || "";
        let isApiKeyValid = false;

        const MODEL_OCR = "gemini-2.5-flash-preview-09-2025";
        const MODEL_IMAGE = "gemini-2.5-flash-image-preview";

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const apiKeyInput = document.getElementById('api-key-input');
        const verifyBtn = document.getElementById('verify-key-btn');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const keyLoader = document.getElementById('key-check-loader');
        const toast = document.getElementById('toast');

        // 初始化顯示
        if (userApiKey) { apiKeyInput.value = userApiKey; }

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.style.backgroundColor = isError ? '#ef4444' : '#0f172a';
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
        }

        async function verifyApiKey() {
            const key = apiKeyInput.value.trim();
            if (!key) { updateStatus('idle', '尚未輸入'); showToast('請先輸入 API Key', true); return; }
            updateStatus('loading', '正在驗證...');
            keyLoader.classList.remove('hidden'); verifyBtn.disabled = true;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();
                if (response.ok) {
                    userApiKey = key; localStorage.setItem('gemini_api_key', key);
                    isApiKeyValid = true; updateStatus('success', '驗證成功');
                    showToast('金鑰驗證成功，可以使用所有功能。');
                } else { throw new Error(data.error?.message || "驗證失敗"); }
            } catch (err) {
                isApiKeyValid = false; updateStatus('error', '金鑰無效');
                showToast(`金鑰無效: ${err.message}`, true);
            } finally { keyLoader.classList.add('hidden'); verifyBtn.disabled = false; updateGlobalControls(); }
        }

        function updateStatus(type, text) {
            statusText.textContent = text;
            statusText.className = `text-[10px] font-black uppercase tracking-widest status-${type}`;
            const dots = { idle: 'bg-slate-300', success: 'bg-emerald-500 animate-pulse', error: 'bg-red-500', loading: 'bg-blue-500 animate-pulse' };
            statusDot.className = `w-2 h-2 rounded-full ${dots[type]}`;
        }

        verifyBtn.onclick = verifyApiKey;

        const wait = (ms) => new Promise(res => setTimeout(res, ms));

        async function fetchWithRetry(url, options, maxRetries = 5) {
            if (!isApiKeyValid) { showToast("請先完成 API 金鑰驗證", true); throw new Error("Key not verified"); }
            const delays = [2000, 4000, 8000, 16000, 32000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${url}${url.includes('?') ? '&' : '?'}key=${userApiKey}`, options);
                    const result = await response.json();
                    if (response.ok) return result;
                    if (response.status === 429) {
                        if (i < maxRetries - 1) {
                            showToast(`頻率限制，${delays[i]/1000}秒後重試...`, true);
                            await wait(delays[i]);
                            continue;
                        }
                    }
                    if (result.candidates?.[0]?.finishReason === 'SAFETY') {
                        throw new Error("圖片內容遭安全過濾 (SAFETY)");
                    }
                    throw new Error(result.error?.message || `HTTP ${response.status}`);
                } catch (e) { 
                    if (i === maxRetries - 1) throw e; 
                    await wait(delays[i]); 
                }
            }
        }

        function base64ToUint8Array(base64) {
            const binaryString = window.atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes;
        }

        const slotsContainer = document.getElementById('slots-container');
        const processAllBtn = document.getElementById('process-all-btn');
        const clearAllSlotsBtn = document.getElementById('clear-all-slots-btn');
        const resultExportGroup = document.getElementById('result-export-group');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const exportResultsPptxBtn = document.getElementById('export-results-pptx-btn');
        const slotCountSelect = document.getElementById('slot-count-select');

        let slots = [];

        // --- 修正：智慧型槽位初始化與擴充 ---
        function initSlots(count) {
            // 備份現有的有效內容
            const currentData = slots.map(s => ({ 
                b64: s.originalBase64, 
                res: s.resultImg.src,
                statusText: s.statusBadge.textContent,
                statusClass: s.statusBadge.className,
                errorVisible: !s.errorOverlay.classList.contains('hidden'),
                errorMsg: s.errorMsg.textContent
            }));
            
            slotsContainer.innerHTML = ''; 
            slots = [];

            for (let i = 0; i < count; i++) {
                const clone = document.getElementById('slot-template').content.cloneNode(true);
                const card = clone.querySelector('.slot-card');
                const data = {
                    index: i, el: card,
                    originalImg: card.querySelector('.original-img'),
                    resultImg: card.querySelector('.result-img'),
                    loader: card.querySelector('.slot-loader'),
                    statusBadge: card.querySelector('#slot-status-badge'),
                    errorOverlay: card.querySelector('#error-overlay'),
                    errorMsg: card.querySelector('#error-msg'),
                    originalBase64: null
                };
                card.querySelector('.slot-label').textContent = `SLOT ${String(i+1).padStart(2, '0')}`;
                card.querySelector('.process-btn').onclick = () => processSlot(i);
                card.querySelector('.remove-btn').onclick = () => resetSlot(i);
                slots.push(data); 
                slotsContainer.appendChild(card);

                // 還原備份的內容（若該索引有資料）
                if (currentData[i]?.b64) {
                    const item = currentData[i];
                    data.originalBase64 = item.b64;
                    data.originalImg.src = `data:image/png;base64,${item.b64}`;
                    card.querySelector('.empty-state').classList.add('hidden');
                    card.querySelector('.active-state').classList.remove('hidden');
                    
                    if (item.res.startsWith('data:image')) {
                        data.resultImg.src = item.res;
                        data.resultImg.classList.remove('hidden');
                        card.querySelector('.placeholder').classList.add('hidden');
                        card.querySelector('.download-btn').disabled = false;
                        card.querySelector('.download-btn').onclick = () => triggerDownload(data.resultImg.src, `cleaned_${i+1}.png`);
                    }

                    if (item.statusText) {
                        data.statusBadge.textContent = item.statusText;
                        data.statusBadge.className = item.statusClass;
                        data.statusBadge.classList.remove('hidden');
                    }

                    if (item.errorVisible) {
                        data.errorOverlay.classList.remove('hidden');
                        data.errorMsg.textContent = item.errorMsg;
                    }
                }
            }
            // 同步下拉選單的值
            if ([4, 8, 12, 20].includes(count)) {
                slotCountSelect.value = count.toString();
            }
            updateGlobalControls();
        }

        // --- 修正：支援自動擴展的 fillSlot ---
        function fillSlot(url) {
            let slot = slots.find(s => !s.originalBase64);
            if (!slot) {
                // 如果沒位子了，自動增加一個槽位並重新尋找
                const newCount = slots.length + 1;
                initSlots(newCount);
                slot = slots[slots.length - 1];
            }
            
            slot.originalBase64 = url.split(',')[1];
            slot.originalImg.src = url;
            slot.el.querySelector('.empty-state').classList.add('hidden');
            slot.el.querySelector('.active-state').classList.remove('hidden');
            updateGlobalControls();
        }

        async function triggerDownload(dataUrl, filename) {
            const response = await fetch(dataUrl);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            window.URL.revokeObjectURL(url); document.body.removeChild(a);
        }

        async function processSlot(i) {
            const s = slots[i]; if (!s.originalBase64 || !isApiKeyValid) return;
            s.loader.classList.remove('hidden');
            s.errorOverlay.classList.add('hidden');
            s.statusBadge.textContent = "處理中";
            s.statusBadge.className = "status-badge badge-processing";
            s.statusBadge.classList.remove('hidden');
            try {
                const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:generateContent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [
                                { text: "Please remove all text and annotations from this physics diagram, and fill the missing areas naturally with the surrounding background color and texture. Keep the lines and objects intact." }, 
                                { inlineData: { mimeType: "image/png", data: s.originalBase64 } }
                            ] 
                        }],
                        generationConfig: { responseModalities: ['TEXT', 'IMAGE'], temperature: 0.4 }
                    })
                });
                const imagePart = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
                if (imagePart?.inlineData?.data) {
                    const b64 = imagePart.inlineData.data;
                    s.resultImg.src = `data:image/png;base64,${b64}`;
                    s.resultImg.classList.remove('hidden');
                    s.el.querySelector('.placeholder').classList.add('hidden');
                    s.el.querySelector('.download-btn').disabled = false;
                    s.el.querySelector('.download-btn').onclick = () => triggerDownload(s.resultImg.src, `cleaned_${i+1}.png`);
                    s.statusBadge.textContent = "完成";
                    s.statusBadge.className = "status-badge badge-done";
                    return true;
                } else { throw new Error("API 未回傳圖片數據"); }
            } catch (e) {
                s.errorOverlay.classList.remove('hidden');
                s.errorMsg.textContent = e.message;
                s.statusBadge.textContent = "失敗";
                s.statusBadge.className = "status-badge badge-error";
                return false;
            } finally { s.loader.classList.add('hidden'); updateGlobalControls(); }
        }

        downloadAllBtn.onclick = async () => {
            const results = slots.filter(s => s.resultImg.src.startsWith('data:image'));
            if (results.length === 0) return;
            downloadAllBtn.disabled = true; downloadAllBtn.textContent = "正在打包...";
            showToast(`正在穩定打包 ${results.length} 張圖片...`);
            try {
                const zip = new JSZip();
                const now = new Date();
                for (let i = 0; i < results.length; i++) {
                    const base64Data = results[i].resultImg.src.split(',')[1];
                    const binaryData = base64ToUint8Array(base64Data);
                    zip.file(`processed_image_${i + 1}.png`, binaryData, { 
                        date: now,
                        createFolders: false,
                        binary: true,
                        unixPermissions: "644",
                        dosPermissions: 0x20 
                    });
                }
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 },
                    platform: "DOS",
                    streamFiles: true 
                });
                const finalBlob = new Blob([content], { type: "application/zip" });
                const url = window.URL.createObjectURL(finalBlob);
                const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = `Physics_AI_Results_${Date.now()}.zip`;
                document.body.appendChild(a); a.click();
                setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 500);
                showToast("下載成功！已採用 Windows 原生相容模式封裝。");
            } catch (err) { showToast("打包出錯", true); } finally { downloadAllBtn.disabled = false; downloadAllBtn.textContent = "打包下載背景圖 (ZIP)"; }
        };

        exportResultsPptxBtn.onclick = async () => {
            const results = slots.filter(s => s.resultImg.src.startsWith('data:image'));
            if (results.length === 0) return showToast("沒有可導出的去字結果圖片", true);
            showToast("正在產生結果 PPTX，請稍候...");
            try {
                const pptx = new PptxGenJS();
                const ratio = document.getElementById('pdf-ratio-select').value;
                if (ratio === '9:16') { pptx.defineLayout({ name: 'MOBILE', width: 5.625, height: 10 }); pptx.layout = 'MOBILE'; }
                else if (ratio === '4:3') { pptx.layout = 'LAYOUT_4x3'; }
                else { pptx.layout = 'LAYOUT_WIDE'; }
                for (const s of results) {
                    const slide = pptx.addSlide();
                    slide.addImage({ data: s.resultImg.src, x: 0, y: 0, w: '100%', h: '100%' });
                }
                await pptx.writeFile({ fileName: `Cleaned_Results_${Date.now()}.pptx` });
                showToast("結果 PPTX 導出成功！");
            } catch (err) { showToast("PPTX 導出失敗", true); }
        };

        async function callAiOcr(base64) {
            const prompt = `請辨識圖片中「所有」文字區塊。JSON 格式包含：text, box_2d [ymin, xmin, ymax, xmax], font_size, is_bold, align, color。座標比例 0-1000。`;
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                text: { type: "STRING" },
                                box_2d: { type: "ARRAY", items: { type: "NUMBER" }, minItems: 4, maxItems: 4 },
                                font_size: { type: "NUMBER" },
                                is_bold: { type: "BOOLEAN" },
                                align: { type: "STRING" },
                                color: { type: "STRING" }
                            },
                            required: ["text", "box_2d"]
                        }
                    }
                }
            };
            const data = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_OCR}:generateContent`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
            return textResult ? JSON.parse(textResult) : [];
        }

        document.getElementById('pdf-to-pptx-btn').onclick = async () => {
            if (!isApiKeyValid) { showToast("請先完成 API 金鑰驗證", true); return; }
            if (currentPdfPageUrls.length === 0) { showToast("請先解析 PDF 檔案", true); return; }
            const btn = document.getElementById('pdf-to-pptx-btn');
            const txt = document.getElementById('pptx-btn-text');
            const ldr = document.getElementById('pptx-loader');
            btn.disabled = true; ldr.classList.remove('hidden');
            showToast(`開始視覺辨識文字 PPTX 程序...`);
            try {
                const pptx = new PptxGenJS();
                const ratio = document.getElementById('pdf-ratio-select').value;
                if (ratio === '9:16') { pptx.defineLayout({ name: 'MOBILE', width: 5.625, height: 10 }); pptx.layout = 'MOBILE'; }
                else if (ratio === '4:3') { pptx.layout = 'LAYOUT_4x3'; }
                else { pptx.layout = 'LAYOUT_WIDE'; }
                for (let i = 0; i < currentPdfPageUrls.length; i++) {
                    txt.textContent = `解析中 (${i+1}/${currentPdfPageUrls.length})`;
                    const base64 = currentPdfPageUrls[i].split(',')[1];
                    const blocks = await callAiOcr(base64);
                    const slide = pptx.addSlide(); slide.background = { fill: "FFFFFF" };
                    if (blocks && blocks.length > 0) {
                        blocks.forEach(block => {
                            if (!block.text || !block.box_2d) return;
                            const ymin = block.box_2d[0], xmin = block.box_2d[1], ymax = block.box_2d[2], xmax = block.box_2d[3];
                            slide.addText(block.text, {
                                x: `${(xmin / 10).toFixed(2)}%`, y: `${(ymin / 10).toFixed(2)}%`,
                                w: `${((xmax - xmin) / 10).toFixed(2)}%`, h: `${((ymax - ymin) / 10).toFixed(2)}%`,
                                fontSize: block.font_size || 12, color: block.color?.replace('#','') || '000000',
                                bold: block.is_bold || false, align: block.align || 'left', valign: 'middle'
                            });
                        });
                    }
                    await wait(2000); 
                }
                pptx.writeFile({ fileName: `Restore_${Date.now()}.pptx` });
                showToast('PPTX 重建下載成功！');
            } catch (err) { showToast(`還原出錯: ${err.message}`, true); } finally {
                btn.disabled = false; ldr.classList.add('hidden'); txt.textContent = '視覺辨識文字 PPTX';
            }
        };

        let currentPdfPageUrls = [];
        const pdfPagesList = document.getElementById('pdf-pages-list');
        const pdfPreviewContainer = document.getElementById('pdf-preview-container');
        const pdfControls = document.getElementById('pdf-controls');

        async function processPdf(file) {
            showToast('正在解析 PDF...'); currentPdfPageUrls = [];
            pdfPreviewContainer.classList.remove('hidden'); pdfControls.classList.remove('hidden');
            pdfPagesList.innerHTML = ''; document.getElementById('pdf-empty-state').classList.add('hidden');
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                document.getElementById('page-count-tag').textContent = `${pdf.numPages} PAGES`;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2 });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    const dataUrl = canvas.toDataURL('image/png');
                    currentPdfPageUrls.push(dataUrl);
                    const div = document.createElement('div');
                    div.className = 'page-card bg-white p-2 rounded-2xl border border-slate-100 shadow-sm relative group cursor-grab w-[200px]';
                    div.innerHTML = `<div class="relative overflow-hidden rounded-xl"><img src="${dataUrl}" class="w-full"><button class="add-btn absolute top-2 right-2 bg-blue-600 text-white w-8 h-8 rounded-lg opacity-0 group-hover:opacity-100 transition shadow-xl font-black">＋</button></div><div class="text-[10px] font-black text-center mt-2 text-slate-400 uppercase">Page ${i}</div>`;
                    div.querySelector('.add-btn').onclick = (e) => { e.stopPropagation(); fillSlot(dataUrl); };
                    pdfPagesList.appendChild(div);
                }
            } catch (err) { showToast('PDF 解析失敗', true); }
        }

        // --- 修正：一鍵導入優化，預先計算所需數量 ---
        document.getElementById('add-all-pages-btn').onclick = () => {
            if (currentPdfPageUrls.length === 0) return;
            showToast(`正在導入 ${currentPdfPageUrls.length} 個頁面至工作台...`);
            
            // 如果當前槽位總量不足以容納所有 PDF 頁面，一次性擴展
            if (slots.length < currentPdfPageUrls.length) {
                initSlots(currentPdfPageUrls.length);
            }
            
            currentPdfPageUrls.forEach(url => fillSlot(url));
        };

        processAllBtn.onclick = async () => {
            const pending = slots.filter(s => s.originalBase64 && !s.resultImg.src.startsWith('data'));
            if (pending.length === 0) return;
            processAllBtn.disabled = true;
            showToast(`開始批次處理 ${pending.length} 個槽位...`);
            for (const s of pending) {
                const success = await processSlot(s.index);
                await wait(success ? 3000 : 1500); 
            }
            showToast("批次程序執行完畢");
            processAllBtn.disabled = false;
            updateGlobalControls();
        };

        function updateGlobalControls() {
            const hasProcessable = slots.some(s => s.originalBase64 && !s.resultImg.src.startsWith('data'));
            const hasResults = slots.some(s => s.resultImg.src.startsWith('data:image'));
            const hasAnyContent = slots.some(s => s.originalBase64);
            processAllBtn.classList.toggle('hidden', !hasAnyContent); processAllBtn.disabled = !isApiKeyValid || !hasProcessable;
            resultExportGroup.classList.toggle('hidden', !hasResults); clearAllSlotsBtn.classList.toggle('hidden', !hasAnyContent);
            document.getElementById('pdf-to-pptx-btn').disabled = !isApiKeyValid;
            document.querySelectorAll('.process-btn').forEach(btn => btn.disabled = !isApiKeyValid);
        }

        document.getElementById('pdf-file-input').onchange = (e) => { if(e.target.files[0]) processPdf(e.target.files[0]); };
        document.getElementById('pdf-drop-zone').onclick = (e) => { if(!e.target.closest('#pdf-preview-container')) document.getElementById('pdf-file-input').click(); };
        document.getElementById('clear-pdf-btn').onclick = () => {
            pdfPagesList.innerHTML = ''; currentPdfPageUrls = [];
            pdfPreviewContainer.classList.add('hidden'); pdfControls.classList.add('hidden');
            document.getElementById('pdf-empty-state').classList.remove('hidden');
        };
        document.getElementById('master-drop-zone').onclick = () => document.getElementById('master-file-input').click();
        document.getElementById('master-file-input').onchange = (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader(); reader.onload = (ev) => fillSlot(ev.target.result); reader.readAsDataURL(file);
            });
        };
        document.getElementById('clear-all-slots-btn').onclick = () => { 
            slots = []; 
            initSlots(4); 
            showToast('工作台已完全重置'); 
        };
        slotCountSelect.onchange = (e) => initSlots(parseInt(e.target.value));

        function resetSlot(i) {
            const s = slots[i]; s.originalBase64 = null; s.resultImg.src = '';
            s.resultImg.classList.add('hidden'); s.el.querySelector('.empty-state').classList.remove('hidden');
            s.el.querySelector('.active-state').classList.add('hidden');
            s.el.querySelector('.placeholder').classList.remove('hidden');
            s.el.querySelector('.download-btn').disabled = true;
            s.errorOverlay.classList.add('hidden'); s.statusBadge.classList.add('hidden');
            updateGlobalControls();
        }

        if (userApiKey) verifyApiKey();
        initSlots(4);
    </script>
</body>
</html>